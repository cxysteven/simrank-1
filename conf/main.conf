#!/bin/sh

CURRENT_DIR=$(dirname $0);

################################################  config #######################################
# process $(TOTAL) days data
PRESERVE_DAYS=30
PROCESS_DAYS=30  # 对PROCESS_DAYS天的pv 日志进行处理,对每天的pv日志生成一份单天pv数据

WEEK_ACCUMULATE_DAYS=7 # 累加一周的数据
MONTH_ACCUMULATE_DAYS=30 # 累加一个月的数据

WEEK_MIN_PV=2  # 统计一周数据的时候, 过滤pv 小于WEEK_MIN_PV的数据
MONTH_MIN_PV=5  # 统计一个月数据的时候, 过滤pv 小于MONTH_MIN_PV的数据

# set reduce num
REDUCE_NUM=200

# normalize option 
NORMALIZE_OPTION=124
PROP_NUM=4
CAT_NUM=1

# java config
JAVA_OPTS="-Xmx2048m"

# 只统计这些pid上的query pv

# 新版搜索右方 420434_1006
# 新版搜索下方 420435_1006
# 新版listing右方 420436_1006
# 新版listing下方 420437_1006

# search右上 419252_1006
# search下 419095_1006
# list右上 419253_1006
# list下 419096_1006

# 淘客searching右上 419392_1007   
# 淘客searching下 419393_1007
# 淘客listing右上 420724_1006
# 淘客listing下 420725_1006

#PIDS=420434_1006,420435_1006,420436_1006,420437_1006,419252_1006,419095_1006,419253_1006,419096_1006,419392_1007,419393_1007,420724_1006,420725_1006
PIDS=420434_1006,420436_1006,419252_1006,419253_1006,419392_1007,420724_1006

################################################ jar path #######################################
JAR_TOOLS_PATH="/home/a/var/share/parsers/lib/Tools.jar";
JAR_TOOLKIT_PATH="/home/a/var/share/parsers/lib/toolkit-common-lang-1.0.jar";
JAR_FRAMEWORK_PATH="/home/a/var/share/framework_hadoop/framework.jar";
JAR_LOGUTIL_PATH="/home/a/var/sds/util/LogUtil.jar";
JAR_P4P_PV_PARSER_PATH="/home/a/var/sds/parsers/P4PPVLogParser.jar";

JAR_NORM_PATH="${CURRENT_DIR}/../jar/algo-normalize-jni.2.0.19-1.jar";
JAR_QUERY_PV_PATH="${CURRENT_DIR}/../jar/QueryPv.jar";

LIB_JARS="$JAR_TOOLS_PATH,${JAR_FRAMEWORK_PATH},${JAR_TOOLKIT_PATH},${JAR_LOGUTIL_PATH},${JAR_P4P_PV_PARSER_PATH}";
LIB_JARS="${JAR_LOGUTIL_PATH},${JAR_P4P_PV_PARSER_PATH}"; 

################################################ job config #######################################
ALIWS_URL=/group/tbalgo/ws/algo-normalize-2.0.19-1.jar#ws 
#ALIWS_URL=/group/tbalgo-dev/zhanying/ws/algo-normalize-2.0.19-1.jar#ws
################################################ class path #######################################
CLASS_LAUNCHER="com.alimama.loganalyzer.common.Launcher";
CLASS_MULTIJOIN="com.alimama.loganalyzer.jobs.tool.MultiJoinProcessor";

CLALL_QUERY_PV="com.taobao.research.jobs.querypv.QueryPv";
CLALL_ACCUMULATE="com.taobao.research.jobs.querypv.Accumulate";
CLASS_QUERYNORM="com.taobao.research.jobs.querypv.QueryNorm";
################################################ input path #######################################
HADOOP_P4P_PV_LOG_BASE_DIR="/group/tbads/logdata/p4p_pv2";
#HADOOP_P4P_PV_LOG_BASE_DIR="/group/tbalgo-dev/jianshen/p4p_pv2";

################################################ output path #######################################
HADOOP_OUTPUT_BASE_DIR="/group/tbalgo/algo_db";
#HADOOP_OUTPUT_BASE_DIR="/group/tbalgo-dev/jianshen";
HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR="${HADOOP_OUTPUT_BASE_DIR}/${CURRENT_DATE}/query_pv/output/one_day_query_pv";
HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR="${HADOOP_OUTPUT_BASE_DIR}/${CURRENT_DATE}/query_pv/output/multi_day_query_pv";
HADOOP_OUTPUT_MONTH_MULTI_DATE_QUERY_PV_DIR="${HADOOP_OUTPUT_BASE_DIR}/${CURRENT_DATE}/query_pv/output/month_multi_day_query_pv";
HADOOP_OUTPUT_MULTI_DATE_QUERY_NORM_DIR="${HADOOP_OUTPUT_BASE_DIR}/${CURRENT_DATE}/query_pv/output/multi_day_query_norm";

LOCAL_OUTPUT_BASE_DIR="${CURRENT_DIR}/../data";
LOCAL_OUTPUT_CURRENT_DATE_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_query_pv.utf8.txt";
LOCAL_OUTPUT_CURRENT_DATE_K_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_k_query_pv.utf8.txt";
LOCAL_OUTPUT_CURRENT_DATE_KBP_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_kbp_query_pv.utf8.txt"; #KBP:keyword,back catid,prop id
LOCAL_OUTPUT_CURRENT_DATE_KFP_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_kfp_query_pv.utf8.txt"; #KBP:keyword,front catid,prop id
LOCAL_OUTPUT_CURRENT_DATE_KFBP_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_kfbp_query_pv.utf8.txt"; #KFBP:keyword,front catid,back catid,prop id
LOCAL_OUTPUT_CURRENT_DATE_BP_QUEYR_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/one_day_bp_query_pv.utf8.txt"; #BP:back catid,prop id

LOCAL_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_query_pv.utf8.txt";
LOCAL_OUTPUT_WEEK_MULTI_DATE_KBP_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_kbp_query_pv.utf8.txt";
LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBP_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_kfbp_query_pv.utf8.txt";
LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBPC_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_kfbpc_query_pv.utf8.txt";
LOCAL_OUTPUT_WEEK_MULTI_DATE_BP_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_bp_query_pv.utf8.txt";

LOCAL_OUTPUT_MONTH_MULTI_DATE_KFBP_QUERY_PV_PATH="${LOCAL_OUTPUT_BASE_DIR}/month_multi_day_kfbp_query_pv.utf8.txt"

LOCAL_OUTPUT_MULTI_DATE_QUERY_NORM_PATH="${LOCAL_OUTPUT_BASE_DIR}/multi_day_query_norm.utf8.txt";
####################################### download file config #######################################
# 
HADOOP_2_LOCAL_DATA_FILE_LIST="";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/kb_pv*:${LOCAL_OUTPUT_CURRENT_DATE_QUEYR_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/k_pv*:${LOCAL_OUTPUT_CURRENT_DATE_K_QUEYR_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/kbp_pv*:${LOCAL_OUTPUT_CURRENT_DATE_KBP_QUEYR_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/kfp_pv*:${LOCAL_OUTPUT_CURRENT_DATE_KFP_QUEYR_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/kfbp_pv*:${LOCAL_OUTPUT_CURRENT_DATE_KFBP_QUEYR_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_CURRENT_DATE_QUERY_PV_DIR}/bp_pv*:${LOCAL_OUTPUT_CURRENT_DATE_BP_QUEYR_PV_PATH}";

HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR}/kb_pv*:${LOCAL_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR}/kbp_pv*:${LOCAL_OUTPUT_WEEK_MULTI_DATE_KBP_QUERY_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR}/kfbp_pv*:${LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBP_QUERY_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR}/kfbpc_pv*:${LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBPC_QUERY_PV_PATH}";
HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_DIR}/bp_pv*:${LOCAL_OUTPUT_WEEK_MULTI_DATE_BP_QUERY_PV_PATH}";

HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_MONTH_MULTI_DATE_QUERY_PV_DIR}/kfbp_pv*:${LOCAL_OUTPUT_MONTH_MULTI_DATE_KFBP_QUERY_PV_PATH}";

HADOOP_2_LOCAL_DATA_FILE_LIST="${HADOOP_2_LOCAL_DATA_FILE_LIST} ${HADOOP_OUTPUT_MULTI_DATE_QUERY_NORM_DIR}/part*:${LOCAL_OUTPUT_MULTI_DATE_QUERY_NORM_PATH}";

#########################################   monitor config  #######################################
#
MONITOR_TXT_FILE_LIST="";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_QUEYR_PV_PATH}:1000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_K_QUEYR_PV_PATH}:1000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_KBP_QUEYR_PV_PATH}:1000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_KFP_QUEYR_PV_PATH}:1000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_KFBP_QUEYR_PV_PATH}:1000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_CURRENT_DATE_BP_QUEYR_PV_PATH}:500000";

MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_WEEK_MULTI_DATE_QUERY_PV_PATH}:2000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_WEEK_MULTI_DATE_KBP_QUERY_PV_PATH}:2000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBP_QUERY_PV_PATH}:2000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_WEEK_MULTI_DATE_KFBPC_QUERY_PV_PATH}:2000000";
MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_WEEK_MULTI_DATE_BP_QUERY_PV_PATH}:1000000";

MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_MONTH_MULTI_DATE_KFBP_QUERY_PV_PATH}:2000000";

MONITOR_TXT_FILE_LIST="${MONITOR_TXT_FILE_LIST} ${LOCAL_OUTPUT_MULTI_DATE_QUERY_NORM_PATH}:2000000";

################################################ log config #######################################
LOG_FILE_PATH="${CURRENT_DIR}/../log/query_pv.log.$(date +%Y%m%d)";

################################################ mail config #######################################
MAIL_ADDRESS_LIST="xizhao@taobao.com,zhenghong@taobao.com,jianshen@taobao.com,huitong@taobao.com,rongdi.zzl@taobao.com,zhihong@taobao.com,zhanying@taobao.com";
#MAIL_ADDRESS_LIST="";
MAIL_SUBJECT="query pv hadoop job";
